<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Optimizer</title>
    <!-- This script pulls in the Tailwind CSS library -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        /* Custom scrollbar for better aesthetics */
        textarea::-webkit-scrollbar, #result-display::-webkit-scrollbar {
            width: 8px;
        }
        textarea::-webkit-scrollbar-track, #result-display::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb, #result-display::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        textarea::-webkit-scrollbar-thumb:hover, #result-display::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* This ensures the output text wraps correctly */
        #result-display {
            white-space: pre-wrap; 
            word-wrap: break-word;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div class="container mx-auto max-w-6xl w-full bg-white rounded-2xl shadow-2xl p-6 md:p-10">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-800">ATS Optimizer</h1>
            <p class="text-gray-600 mt-2 text-lg">Tailor Your Resume to Any Job Description with AI Agents</p>
        </header>

        <!-- Main Content Area -->
        <main class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            <!-- Input Section -->
            <div class="space-y-6">
                <div>
                    <label for="jd-input" class="block text-lg font-semibold text-gray-700 mb-2">1. Paste Job Description</label>
                    <textarea id="jd-input" rows="12" class="w-full p-4 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 ease-in-out" placeholder="Paste the full job description here..."></textarea>
                </div>
                <div>
                    <label for="resume-upload" class="block text-lg font-semibold text-gray-700 mb-2">2. Upload Master Resume</label>
                    <div id="upload-container" class="mt-2 flex justify-center rounded-lg border border-dashed border-gray-900/25 px-6 py-10">
                        <div class="text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M1.5 6a2.25 2.25 0 012.25-2.25h16.5A2.25 2.25 0 0122.5 6v12a2.25 2.25 0 01-2.25 2.25H3.75A2.25 2.25 0 011.5 18V6zM3 16.06V18c0 .414.336.75.75.75h16.5A.75.75 0 0021 18v-1.94l-2.69-2.689a1.5 1.5 0 00-2.12 0l-.88.879.97.97a.75.75 0 11-1.06 1.06l-5.16-5.159a1.5 1.5 0 00-2.12 0L3 16.061zm10.125-7.81a1.125 1.125 0 112.25 0 1.125 1.125 0 01-2.25 0z" clip-rule="evenodd" />
                            </svg>
                            <div class="mt-4 flex text-sm leading-6 text-gray-600">
                                <label for="resume-upload-input" class="relative cursor-pointer rounded-md bg-white font-semibold text-indigo-600 focus-within:outline-none focus-within:ring-2 focus-within:ring-indigo-600 focus-within:ring-offset-2 hover:text-indigo-500">
                                    <span>Upload a file</span>
                                    <input id="resume-upload-input" name="resumeFile" type="file" class="sr-only" accept=".docx,.pdf">
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p id="file-name-display" class="text-xs leading-5 text-gray-600">DOCX or PDF up to 10MB</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Output Section -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner flex flex-col">
                 <h2 class="text-lg font-semibold text-gray-700 mb-2">3. Optimized Resume</h2>
                <div id="result-container" class="flex-grow border border-gray-200 rounded-lg bg-white p-4 overflow-y-auto">
                    <div id="placeholder" class="text-gray-400">
                        Your tailored resume will appear here...
                    </div>
                    <div id="loader" class="hidden flex flex-col items-center justify-center h-full">
                        <svg class="animate-spin h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-gray-600">Agents are at work... this may take a moment.</p>
                    </div>
                    <div id="result-display" class="hidden"></div>
                    <div id="error-message" class="hidden text-red-600 bg-red-100 p-4 rounded-lg"></div>
                </div>
            </div>
        </main>

        <!-- Action Button -->
        <footer class="text-center mt-8">
            <button id="optimize-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                Optimize My Resume
            </button>
        </footer>
    </div>

    <!-- START OF JAVASCRIPT LOGIC -->
    <script>
        // Get references to all interactive elements
        const optimizeBtn = document.getElementById('optimize-btn');
        const jdInput = document.getElementById('jd-input');
        const uploadInput = document.getElementById('resume-upload-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        
        const placeholder = document.getElementById('placeholder');
        const loader = document.getElementById('loader');
        const resultDisplay = document.getElementById('result-display');
        const errorMessage = document.getElementById('error-message');

        // Store the selected file in a global variable
        let selectedFile = null;

        // --- NEW: Event Listener for File Selection ---
        uploadInput.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                selectedFile = files[0];
                fileNameDisplay.textContent = selectedFile.name; // Show the selected file's name
                fileNameDisplay.classList.remove('text-gray-600');
                fileNameDisplay.classList.add('text-indigo-600', 'font-semibold');
            } else {
                selectedFile = null;
                fileNameDisplay.textContent = 'DOCX or PDF up to 10MB';
                fileNameDisplay.classList.add('text-gray-600');
                fileNameDisplay.classList.remove('text-indigo-600', 'font-semibold');
            }
        });

        // --- MODIFIED: Event Listener for the Main Button ---
        optimizeBtn.addEventListener('click', async () => {
            const jdText = jdInput.value;

            // UI State Management
            placeholder.classList.add('hidden');
            resultDisplay.classList.add('hidden');
            errorMessage.classList.remove('hidden');
            errorMessage.textContent = ''; // Clear previous errors
            loader.classList.remove('hidden');
            
            // --- MODIFIED: Validation now checks for a file ---
            if (!jdText.trim() || !selectedFile) {
                errorMessage.textContent = 'Please paste the job description and upload a resume file.';
                errorMessage.classList.remove('hidden');
                loader.classList.add('hidden');
                return;
            }
            
            // --- NEW: Use FormData to send both text and file ---
            const formData = new FormData();
            formData.append('jd', jdText);
            formData.append('resumeFile', selectedFile);

            const backendUrl = 'https://ats-optimizer-backend-206199118543.us-central1.run.app/api/optimize-resume';

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    // IMPORTANT: When sending FormData, DO NOT set the 'Content-Type' header.
                    // The browser will automatically set it with the correct boundary.
                    body: formData,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // --- NEW: Handle file download ---
                const blob = await response.blob(); // Get the file data as a blob
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); // Create a temporary link element
                a.style.display = 'none';
                a.href = url;
                // Suggest a filename for the download
                a.download = `Tailored_Resume_${selectedFile.name}`;
                document.body.appendChild(a);
                a.click(); // Programmatically click the link to trigger the download
                window.URL.revokeObjectURL(url); // Clean up the object URL
                document.body.removeChild(a); // Clean up the link element

                // Show a success message in the UI
                placeholder.classList.remove('hidden');
                placeholder.textContent = 'Success! Your tailored resume has been downloaded.';

            } catch (error) {
                console.error('Error during optimization:', error);
                errorMessage.textContent = `An error occurred: ${error.message}`;
                errorMessage.classList.remove('hidden');
            } finally {
                loader.classList.add('hidden');
            }
        });
    </script>
    <!-- END OF JAVASCRIPT LOGIC -->
</body>
</html>